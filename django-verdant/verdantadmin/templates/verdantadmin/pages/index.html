{% extends "verdantadmin/base.html" %}
{% block titletag %}Exploring {{ parent_page.title }}{% endblock %}
{% block bodyclass %}menu-explorer page-explorer {% if ordering == 'ord' %}reordering{% endif %}{% endblock %}

{% block content %}
    <header class="merged no-border">
        <h1>Explorer</h1>

        <ul class="breadcrumb">
            <li><a href="{% url 'verdantadmin_explore_root' %}" class="icon icon-home text-replace">Home</a></li>
            {% for page in parent_page.get_ancestors %}
                <li><a href="{% url 'verdantadmin_explore' page.id %}">{{ page.title }}</a></li>
            {% endfor %}
        </ul>
    </header>
   
    <form id="page-reorder-form">
        {% csrf_token %}

        {% include "verdantadmin/pages/list.html" with sortable=1 allow_navigation=1 full_width=1 parent_page=parent_page orderable=1 %} 
    </form>

{% endblock %}

{% block extra_js %}
    <script type="text/javascript">
        {% if ordering == 'ord' %}
            $(function() {
                var reorderCount = 0;
                var orderform = $('#page-reorder-form');

                $('.listing tbody').sortable({
                    cursor: "move", 
                    containment: "parent", 
                    handle: ".handle", 
                    items: "> tr",
                    axis: "y",
                    placeholder: "dropzone",
                    start: function(){
                        $(this).parent().addClass('sorting');
                    },
                    stop: function(event, ui){
                        $(this).parent().removeClass('sorting');

                        // Work out what page moved and where it moved to
                        var movedElement = ui.item[0];
                        var movedPageId = movedElement.id.substring(5);
                        var newPosition = $(movedElement).prevAll().length;

                        // Build url
                        // TODO: Find better way to inject movedPageId
                        var url = "{% url 'verdantadmin_pages_move_confirm' '999999' parent_page.id %}".replace('999999', movedPageId);
                        url += '?position=' + newPosition;

                        // Get CSRF token
                        var CSRFToken = $('input[name="csrfmiddlewaretoken"]', orderform).val();

                        // Post
                        $.post(url, {csrfmiddlewaretoken: CSRFToken}, function(){
                            addMessage('success', '"' + $(movedElement).data('page-title') + '" has been moved successfully.')
                        })
                    }
                });
                $('.listing tbody').disableSelection();
            })
        {% endif %}
    </script>
{% endblock %}
