{% extends "verdantadmin/base.html" %}
{% load page_permissions %}
{% block titletag %}Exploring {{ parent_page.title }}{% endblock %}
{% block bodyclass %}menu-explorer page-explorer {% if ordering == 'ord' %}reordering{% endif %}{% endblock %}

{% block content %}
    <header class="merged no-border">
        <h1>Explorer</h1>

        <ul class="breadcrumb">
            <li><a href="{% url 'verdantadmin_explore_root' %}" class="icon icon-home text-replace">Home</a></li>
            {% for page in parent_page.get_ancestors %}
                <li><a href="{% url 'verdantadmin_explore' page.id %}">{{ page.title }}</a></li>
            {% endfor %}
        </ul>
    </header>
   
    <form id="page-reorder-form" action="{% url 'verdantadmin_pages_reorder' parent_page.id %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="order" id="order" />

        {% page_permissions parent_page as parent_page_perms %}
        {% include "verdantadmin/pages/list.html" with sortable=1 allow_navigation=1 full_width=1 parent_page=parent_page orderable=parent_page_perms.can_reorder_children %} 

        {% comment %}
            {# Commented out as this is now done with ajax #}
            {% if ordering == 'ord' %}
                <footer>
                    <ul>
                        <li class="actions">
                            <input type="submit" value="Save order" class="button" />
                        </li>
                    </ul>
                </footer>
            {% endif %}
        {% endcomment %}
    </form>

{% endblock %}

{% block extra_js %}
    <script type="text/javascript">
        {% if ordering == 'ord' %}
            function setOrder(){
                $('#order').val($('.listing tbody').sortable('toArray'));
            }

            $(function() {
                var reorderCount = 0;
                var orderform = $('#page-reorder-form');

                orderform.submit(function() {
                    setOrder();
                    return true;
                });

                $('.listing tbody').sortable({
                    cursor: "move", 
                    containment: "parent", 
                    handle: ".handle", 
                    items: "> tr",
                    axis: "y",
                    placeholder: "dropzone",
                    start: function(){
                        $(this).parent().addClass('sorting');
                    },
                    stop: function(){
                        $(this).parent().removeClass('sorting');

                        setOrder();

                        //submit the form silently
                        $.post(orderform.attr('action'), orderform.serialize(), function(){
                            reorderCount++;
                            addMessage('success', 'Pages have been reordered successfully ' + ((reorderCount>1) ? '(' + reorderCount +' times)': ''))
                        })

                    }
                });
                $('.listing tbody').disableSelection();
            })
        {% endif %}
    </script>
{% endblock %}
