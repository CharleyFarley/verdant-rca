{% extends "student_profiles/edit_base.html" %}
{% load static compress %}

{% block form_content %}

<h1>MA show details</h1>

<form method="POST" accept-charset="utf-8" enctype="multipart/form-data">{% csrf_token %}
  
  {% include 'student_profiles/form_snippet.html' with form=show_form %}

  {{ carouselitem_formset.management_form }}
  Carousel images/videos
  <div id="{{ carouselitem_formset.prefix }}">
  {% for carouselitem_form in carouselitem_formset %}
    <div class="well" style="padding: 1em; border: 1px solid black;">
      {{ carouselitem_form.id }}
      {% include 'student_profiles/form_snippet.html' with form=carouselitem_form %}
    <input type="hidden" class="order-value" name="{{ form.prefix }}-ORDER" value="{{ forloop.counter0 }}">
    <a id="move-up"   class="icon text-replace white icon-order-up">↑</a>
    <a id="move-down" class="icon text-replace white icon-order-down " href="javascript:void(0)">↓</a>
    </div>
  {% endfor %}
  </div>

  {% include "student_profiles/formset_single_field.html" with formset=show_collaborators_formset %}
  {% include "student_profiles/formset_single_field.html" with formset=show_sponsors_formset %}


  <p><input type="submit" class="profile-save" value="Save"></p>
</form>

{% endblock form_content %}


{% block extra_css %}
<style type="text/css" media="screen">
  .dropzone {
      background: palegreen;
      width: 150px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      font-weight: bold;
  }
  .dropzone.in {
      width: 600px;
      height: 200px;
      line-height: 200px;
      font-size: larger;
  }
  .dropzone.hover {
      background: lawngreen;
  }
  .dropzone.fade {
      -webkit-transition: all 0.3s ease-out;
      -moz-transition: all 0.3s ease-out;
      -ms-transition: all 0.3s ease-out;
      -o-transition: all 0.3s ease-out;
      transition: all 0.3s ease-out;
      opacity: 1;
  }
</style>

{{ block.super }}
{% endblock extra_css %}


{% block form_js %}
<script src="{% static "student_profiles/js/image_handler.js" %}"></script>
<script type="text/javascript">
$(function() {

  {# prevent default drop handling because we want specific drop zones for our individual file fields #}
  $(document).bind('drop dragover', function (e) {
      e.preventDefault();
  });

  function updateSelects() {
    $('#carousel select').change(function() {
      var value = $(this).val();
      var _match = this.id.match(/id_carousel-(\d+)-item_type/);
      var id_number = _match ? _match[1] : '';
      
      if (value == 'image')        {# image, as defined in forms.py #}
      {
        $('#carousel-' + id_number + '-image_id').show();
        $('#id_carousel-' + id_number + '-overlay_text').parent().show();

        $('#id_carousel-' + id_number + '-embedly_url').parent().hide();
        $('#carousel-' + id_number + '-poster_image_id').hide();
        $('#id_carousel-' + id_number + '-embedly_url').val('');
        $('#carousel-' + id_number + '-poster_image_id input').val('');
      } else if (value == 'video') {# video #}
      {
        $('#carousel-' + id_number + '-image_id').hide();
        $('#id_carousel-' + id_number + '-overlay_text').parent().hide();
        $('#carousel-' + id_number + '-image_id input').val('');
        $('#id_carousel-' + id_number + '-overlay_text').val('');
        
        $('#id_carousel-' + id_number + '-embedly_url').parent().show();
        $('#carousel-' + id_number + '-poster_image_id').show();
      }
    });
  };
  
  $('#{{ show_collaborators_formset.prefix }} .inline-form').formset({
      prefix: '{{ show_collaborators_formset.prefix }}',
      formCssClass: 'dynamic-formset-{{ show_collaborators_formset.prefix }}'
  });

  $('#{{ show_sponsors_formset.prefix }} .inline-form').formset({
      prefix: '{{ show_sponsors_formset.prefix }}',
      formCssClass: 'dynamic-formset-{{ show_sponsors_formset.prefix }}'
  });

  $('#{{ carouselitem_formset.prefix }} .well').formset({
      prefix: '{{ carouselitem_formset.prefix }}',
      formCssClass: 'dynamic-formset-{{ carouselitem_formset.prefix }}',
    added: function(row) {
      updateSelects();
      row.find('select').each(function(){ $(this).trigger('change')});
      row.find('.image-uploader-block').each(function(i) { activateImageUpload(this.id); });
    },
  });
  makeRichTextEditable('id_show_work_description');
  activateImageUpload('postcard_image');
  $('.image-uploader-block').each(function(i) {
    activateImageUpload(this.id);
  });
  
  updateSelects();
  $('#carousel select').each(function(i) {
    $(this).trigger('change');
  });
  
})
</script>
{% endblock form_js %}



